--- a/ssh-add.c	2016-07-13 23:04:27.000000000 -0700
+++ b/ssh-add.c	2016-07-13 23:11:17.000000000 -0700
@@ -331,12 +331,12 @@
 }
 
 static int
-update_card(int agent_fd, int add, const char *id)
+update_card(int agent_fd, int add, const char *id, int no_pin)
 {
 	char *pin = NULL;
 	int r, ret = -1;
 
-	if (add) {
+	if (add && !no_pin) {
 		if ((pin = read_passphrase("Enter passphrase for PKCS#11: ",
 		    RP_ALLOW_STDIN)) == NULL)
 			return -1;
@@ -468,6 +468,7 @@
 	fprintf(stderr, "  -x          Lock agent.\n");
 	fprintf(stderr, "  -X          Unlock agent.\n");
 	fprintf(stderr, "  -s pkcs11   Add keys from PKCS#11 provider.\n");
+	fprintf(stderr, "  -n          Don't ask for PKCS#11 PIN.\n");
 	fprintf(stderr, "  -e pkcs11   Remove keys provided by PKCS#11 provider.\n");
 }
 
@@ -480,6 +481,7 @@
 	char *pkcs11provider = NULL;
 	int r, i, ch, deleting = 0, ret = 0, key_only = 0;
 	int xflag = 0, lflag = 0, Dflag = 0;
+	int no_pin = 0;
 
 	ssh_malloc_init();	/* must be called before any mallocs */
 	/* Ensure that fds 0, 1 and 2 are open or directed to /dev/null */
@@ -507,7 +509,7 @@
 		exit(2);
 	}
 
-	while ((ch = getopt(argc, argv, "klLcdDxXE:e:s:t:")) != -1) {
+	while ((ch = getopt(argc, argv, "klLcdDxXnE:e:s:t:")) != -1) {
 		switch (ch) {
 		case 'E':
 			fingerprint_hash = ssh_digest_alg_by_name(optarg);
@@ -541,6 +543,9 @@
 		case 's':
 			pkcs11provider = optarg;
 			break;
+		case 'n':
+			no_pin = 1;
+			break;
 		case 'e':
 			deleting = 1;
 			pkcs11provider = optarg;
@@ -578,7 +583,7 @@
 	argc -= optind;
 	argv += optind;
 	if (pkcs11provider != NULL) {
-		if (update_card(agent_fd, !deleting, pkcs11provider) == -1)
+		if (update_card(agent_fd, !deleting, pkcs11provider, no_pin) == -1)
 			ret = 1;
 		goto done;
 	}
--- a/ssh-pkcs11.c	2016-07-13 23:04:27.000000000 -0700
+++ b/ssh-pkcs11.c	2016-07-13 23:11:17.000000000 -0700
@@ -232,7 +232,15 @@
 int pkcs11_login(struct pkcs11_key *k11, CK_FUNCTION_LIST *f, struct pkcs11_slotinfo *si) {
 	char			*pin = NULL, prompt[1024];
 	CK_RV			rv;
-	if ((si->token.flags & CKF_LOGIN_REQUIRED) && !si->logged_in) {
+	if ((si->token.flags & CKF_LOGIN_REQUIRED) && !si->logged_in &&
+		(si->token.flags & CKF_PROTECTED_AUTHENTICATION_PATH)) {
+		if ((rv = f->C_Login(si->session, CKU_USER, NULL, 0)) == CKR_OK) {
+			si->logged_in = 1;
+		} else {
+			error("C_Login with protected authentication path failed: %lu", rv);
+		}
+	}
+    if ((si->token.flags & CKF_LOGIN_REQUIRED) && !si->logged_in) {
 		if (!pkcs11_interactive) {
 			error("need pin entry%s", (si->token.flags &
 			    CKF_PROTECTED_AUTHENTICATION_PATH) ?
@@ -525,10 +533,12 @@
 	CK_FUNCTION_LIST	*f;
 	CK_SESSION_HANDLE	session;
 	int			login_required;
+	int			pap;
 
 	f = p->function_list;
 	login_required = p->slotinfo[slotidx].token.flags & CKF_LOGIN_REQUIRED;
-	if (pin && login_required && !strlen(pin)) {
+	pap = p->slotinfo[slotidx].token.flags & CKF_PROTECTED_AUTHENTICATION_PATH;
+	if (pin && login_required && !strlen(pin) && !pap) {
 		error("pin required");
 		return (-1);
 	}
@@ -538,7 +548,14 @@
 		error("C_OpenSession failed: %lu", rv);
 		return (-1);
 	}
-	if (login_required && pin) {
+	if (login_required && pap) {
+		if ((rv = f->C_Login(session, CKU_USER, NULL, 0)) == CKR_OK) {
+			p->slotinfo[slotidx].logged_in = 1;
+		} else {
+			error("C_Login with protected authentication path failed: %lu", rv);
+		}
+	}
+	if (login_required && pin && !p->slotinfo[slotidx].logged_in) {
 		rv = f->C_Login(session, CKU_USER,
 		    (u_char *)pin, strlen(pin));
 		if (rv != CKR_OK && rv != CKR_USER_ALREADY_LOGGED_IN) {
@@ -693,10 +710,22 @@
 			if ((rsa = RSA_new()) == NULL) {
 				error("RSA_new failed");
 			} else {
+				CK_ULONG len = attribs[2].ulValueLen;
+				CK_CHAR_PTR ptr = attribs[2].pValue;
 				rsa->n = BN_bin2bn(attribs[1].pValue,
 				    attribs[1].ulValueLen, NULL);
-				rsa->e = BN_bin2bn(attribs[2].pValue,
-				    attribs[2].ulValueLen, NULL);
+				/*
+				 * Work-around for ActivIdentity bug: Public exponent
+				 * has leading zeros and one trailing zero.
+				 */
+ 				if(ptr[len - 1] == 0x0) {
+					len--;
+					while(ptr[0] == 0x0 && len > 1) {
+						ptr++;
+						len--;
+					}
+				}
+				rsa->e = BN_bin2bn(ptr, len, NULL);
 			}
 #ifdef ENABLE_PKCS11_ECDSA
 		} else if (attribs[1].type == CKA_EC_PARAMS ) {
--- a/ssh-agent.c	2016-12-20 10:47:59.000000000 -0800
+++ b/ssh-agent.c	2016-12-20 10:50:43.000000000 -0800
@@ -89,7 +89,11 @@
 #endif
 
 #ifndef DEFAULT_PKCS11_WHITELIST
-# define DEFAULT_PKCS11_WHITELIST "/usr/lib/*,/usr/local/lib/*"
+# if __APPLE__
+#  define DEFAULT_PKCS11_WHITELIST "/Library/*,/usr/lib/*,/usr/local/lib/*"
+# else
+#  define DEFAULT_PKCS11_WHITELIST "/usr/lib/*,/usr/local/lib/*"
+# endif
 #endif
 
 typedef enum {

